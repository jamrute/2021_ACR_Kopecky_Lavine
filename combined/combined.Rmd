```{r}
library(Seurat)
library(dplyr)
library(viridis)
library(ggplot2)
library(Matrix)
library(RColorBrewer)
library(scales)
library(data.table)
```

```{r}
load("../filtered_transplant.Robj")
```

```{r}
ben_transplant_updated <- UpdateSeuratObject(ben_transplant)
```

```{r}
VlnPlot(ben_transplant_updated, features=c("nCount_RNA", "nFeature_RNA", "percent.mt"))
```


```{r}
andrew_meta <- read.csv("../andrew_ben_transplant_meta.csv", row.names = 1)
```

```{r}
ben_transplant_updated$GFP <- andrew_meta$gfp
ben_transplant_updated$RFP <- andrew_meta$rfp
ben_transplant_updated$CCR2 <- andrew_meta$Ccr2_PosNeg
```

```{r}
save(ben_transplant_updated, file="../filtered_transplant_updated.Robj")
```

```{r}
ben_transplant_updated$DR <- ifelse(ben_transplant_updated$orig.ident %in% c("Pod1D", "Pod7D", "BD"), "Donor", "Recipient")
```

```{r}
DefaultAssay(ben_transplant_updated) <- 'RNA'
ben_transplant_updated <- SCTransform(ben_transplant_updated, vars.to.regress = c("percent.mt"))
```

```{r}
ben_transplant_updated <- RunPCA(ben_transplant_updated, features = VariableFeatures(object = ben_transplant_updated), npcs=50, verbose=TRUE)
ben_transplant_updated <- FindNeighbors(ben_transplant_updated, dims = 1:50, verbose = FALSE)
ben_transplant_updated <- FindClusters(ben_transplant_updated, resolution = c(0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8), verbose = FALSE)
ben_transplant_updated <- RunUMAP(ben_transplant_updated, dims = 1:50, verbose = FALSE)
```

```{r}
ben_transplant_updated$orig.ident <- factor(ben_transplant_updated$orig.ident, levels = c("BD", "Pod1D", "Pod7D", "Pod1R", "Pod7R", "Pod14R"), ordered = TRUE)
```

```{r}
DimPlot(ben_transplant_updated, group.by = "DR", cols=c("dodgerblue4", "red4"))
```

```{r}
DimPlot(ben_transplant_updated, group.by = "orig.ident", cols=c("lightskyblue", "dodgerblue2", "royalblue4", "rosybrown", "red", "red4"))
```

```{r}
DefaultAssay(ben_transplant_updated) <- 'SCT'
Idents(ben_transplant_updated) <- "DR"
ben_transplant_updated.rnamarkers <- FindAllMarkers(ben_transplant_updated, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.25)
write.csv(ben_transplant_updated.rnamarkers, file ="./donor_vs_recipient_DE.csv", quote = FALSE)
```

```{r}
top10 <- ben_transplant_updated.rnamarkers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
DoHeatmap(ben_transplant_updated, features = top10$gene, group.colors=c("dodgerblue4", "red4")) + NoLegend() + scale_fill_viridis()
```

```{r}
DefaultAssay(ben_transplant_updated) <- 'SCT'
Idents(ben_transplant_updated) <- "orig.ident"
ben_transplant_updated.rnamarkers <- FindAllMarkers(ben_transplant_updated, only.pos = TRUE, min.pct = 0.1, logfc.threshold = 0.25)
write.csv(ben_transplant_updated.rnamarkers, file ="./all_conditions_DE.csv", quote = FALSE)
```

```{r}
top10 <- ben_transplant_updated.rnamarkers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC)
DoHeatmap(ben_transplant_updated, features = top10$gene, group.colors=c("lightskyblue", "dodgerblue2", "royalblue4", "rosybrown", "red", "red4")) + NoLegend() + scale_fill_viridis()
```

```{r}
DimPlot(ben_transplant_updated, group.by = "GFP", cols=c("gray75", "green3"))
```

```{r}
DimPlot(ben_transplant_updated, group.by = "GFP", cols=c("gray75", "green3"), split.by = "DR")
```

```{r}
expdata <- GetAssayData(ben_transplant_updated)
Pop1<-c("Socs1","Cxcl10","Lamp1","Xist","Dusp2","Rnaset2a","Irf7","Isg15","Nfil3","Il1rn")
pops<-list(Pop1)

#Z-Scores
z_scores<-NULL

for (i in 1:length(pops)) {
genes <- pops[[i]]
zz <- which(tolower(rownames(expdata)) %in% tolower(genes))
av <- numeric(ncol(expdata))

geneExp <- as.matrix(expdata[zz, ])
geneExp <- t(scale(t(geneExp)))
geneExp[is.nan(geneExp)] <- 0
z_scores <- rbind(z_scores,(av + colSums(geneExp) / length(zz)))
}
ben_transplant_updated@meta.data$pop1_z<-z_scores[1,]
FeaturePlot(object=ben_transplant_updated, features = "pop1_z",pt.size=.5) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,2)) + ggtitle("Socs1,Cxcl10,Lamp1,Xist,Dusp2,Rnaset2a,Irf7,Isg15,Nfil3,Il1rn")
```

```{r}
saveRDS(ben_transplant_updated, "./combined_processed.rds")
```

```{r}
ben_transplant_updated <- readRDS("./combined_processed.rds")
```

```{r}
ben_transplant_updated$orig.ident <- factor(ben_transplant_updated$orig.ident, levels = c("BD", "Pod1D", "Pod7D", "Pod1R", "Pod7R", "Pod14R"), ordered = TRUE)
VlnPlot(ben_transplant_updated, features = c("nCount_RNA","percent.mt","nFeature_RNA"), ncol = 3) + NoLegend()
```





