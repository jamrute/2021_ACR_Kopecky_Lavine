```{r}
library(Seurat)
library(dplyr)
library(viridis)
library(ggplot2)
library(Matrix)
library(RColorBrewer)
library(scales)
library(data.table)
library(ArchR)
```

```{r}
recipient_integrated <- readRDS("/Users/jamrute/Documents/Graduate_School/Thesis_Lab/Lavine_Projects/Secondary/Ben_transplant/Recipient/Integration/post_cleanup/recipient_integrated_annotated.rds")
```

```{r}
DimPlot(recipient_integrated, reduction = "umap", group.by = "annotations", repel = TRUE, ncol=3)
```

###### Preprocessing Steps

# Load the dataset and create a Seurat Object
```{r}
WT_dir <- '/Users/jamrute/Documents/Graduate_School/Thesis_Lab/Lavine_Projects/Secondary/Ben_transplant/MyD88_KO/Matrices/Wildtype-WT/filtered_feature_bc_matrix/'
WT.data <- Read10X(data.dir =WT_dir)
WT <- CreateSeuratObject(counts = WT.data, min.cells = 3, min.features = 200)
WT$orig.ident <- "WT"

MyD88KO_dir <- '/Users/jamrute/Documents/Graduate_School/Thesis_Lab/Lavine_Projects/Secondary/Ben_transplant/MyD88_KO/Matrices/MyD88_Day_3KO/filtered_feature_bc_matrix/'
MyD88KO.data <- Read10X(data.dir =MyD88KO_dir)
MyD88KO <- CreateSeuratObject(counts = MyD88KO.data, min.cells = 3, min.features = 200)
MyD88KO$orig.ident <- "MyD88KO"

query <- merge(WT, y = c(MyD88KO))
```

# QC Filtering
```{r}
query[["percent.mt"]] <- PercentageFeatureSet(query, pattern = "^mt-")
query <- subset(query, subset = nFeature_RNA < 6000 & nCount_RNA < 50000 & percent.mt < 10)
```

# Normalize Query
```{r}
DefaultAssay(query) <- 'RNA'
query <- SCTransform(query, vars.to.regress = c("percent.mt"))
```

# Label Transfer
```{r}
DefaultAssay(query) <- 'SCT'
DefaultAssay(recipient_integrated) <- "integrated"
sample.anchors <- FindTransferAnchors(reference = recipient_integrated, query = query, dims = 1:50, normalization.method = "SCT", npcs = 50)
predictions <- TransferData(anchorset = sample.anchors, refdata = recipient_integrated$annotations, dims = 1:50)
query <- AddMetaData(query, metadata = predictions)
```

```{r}
recipient_integrated <- RunUMAP(recipient_integrated, dims = 1:50, verbose = FALSE, return.model = TRUE)
query <- MapQuery(anchorset = sample.anchors, reference = recipient_integrated, query = query, 
    refdata = list(celltype = "annotations"), reference.reduction = "pca", reduction.model = "umap")
```

# Plot Mapping Results
```{r}
DimPlot(query, reduction = "ref.umap", group.by = "predicted.celltype", repel = TRUE, ncol=3, split.by = "orig.ident") + ggtitle("Query transferred labels")
```

```{r}
FeaturePlot(query, features = unique(query$predicted.celltype),  reduction = "ref.umap", cols = c("lightgrey", "darkred"), ncol = 3) & theme(plot.title = element_text(size = 10))
```
```{r}
FeaturePlot(query, features = c("Gm15056", "Ccl5", "Arg1", "Irgm1", "Ass1", "Ly6a", "Cxcl9", "Serpina3i", "Il1rn",
                                "Spp1", "Cxcl1", "Ifi205", "Isg15", "Top2a", "H2-D1", "Slamf8", "Irf7", "Ccl9",
                                "Fam49b", "H2-T23", "Ly6e", "Cd74", "Cd274", "H2-K1", "Cx3cr1", "H2-DMa", "Ifi47",
                                "Serpina3g", "H2-Ab1", "Ifi44", "H2-Aa", "Oasl2", "Cxcl2", "H2-Q4", "Nos2", "Ifi209", "Nrp2"),  reduction = "ref.umap", ncol=3, split.by = "orig.ident")
ggsave("genes.png", width = 10, height = 100, limitsize = FALSE)
```

```{r}
saveRDS(query, "./query_mapped.rds")
```

```{r}
query <- readRDS("./query_mapped.rds")
```

# Look at cell type breakdown
```{r}
ggplot(query@meta.data, aes(x=orig.ident, fill=predicted.celltype)) + geom_bar(position = "fill") + theme_bw() + theme(axis.text.x = element_text(angle = 90))
```

# T-Cell Activation
```{r}
tc_activation <- list(c("Ccl5", "Cxcl9", "Cd274", "Nos2"))

DefaultAssay(query) <- "SCT"
query <- AddModuleScore(
  object = query,
  features = tc_activation,
  name = 'tc_activation'
)

Idents(query) <- "orig.ident"
query_WT <- subset(query, idents = "WT")
query_MyD88KO <- subset(query, idents = "MyD88KO")
```

```{r}
FeaturePlot(query, reduction = 'ref.umap', features = "tc_activation1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))

FeaturePlot(query_WT, reduction = 'ref.umap', features = "tc_activation1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))

FeaturePlot(query_MyD88KO, reduction = 'ref.umap', features = "tc_activation1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))
```

# IFN
```{r}
IFN <- list(c("Irgm1", "Isg15", "Ifi205", "Ly6a", "Irf7", "Ifi47", "Ifi44", "Oasl2"))

DefaultAssay(query) <- "SCT"
query <- AddModuleScore(
  object = query,
  features = IFN,
  name = 'IFN'
)

Idents(query) <- "orig.ident"
query_WT <- subset(query, idents = "WT")
query_MyD88KO <- subset(query, idents = "MyD88KO")
```

```{r}
FeaturePlot(query, reduction = 'ref.umap', features = "IFN1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))

FeaturePlot(query_WT, reduction = 'ref.umap', features = "IFN1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))

FeaturePlot(query_MyD88KO, reduction = 'ref.umap', features = "IFN1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1)) 
```


# Antigen_presentation
```{r}
antigen_presentation <- list(c("H2-D1", "H2-T23", "Cd74", "H2-K1", "H2-DMa", "H2-Ab1", "H2-Aa", "H2-Q4"))

DefaultAssay(query) <- "SCT"
query <- AddModuleScore(
  object = query,
  features = antigen_presentation,
  name = 'antigen_presentation'
)

Idents(query) <- "orig.ident"
query_WT <- subset(query, idents = "WT")
query_MyD88KO <- subset(query, idents = "MyD88KO")
```

```{r}
FeaturePlot(query, reduction = 'ref.umap', features = "antigen_presentation1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))

FeaturePlot(query_WT, reduction = 'ref.umap', features = "antigen_presentation1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))

FeaturePlot(query_MyD88KO, reduction = 'ref.umap', features = "antigen_presentation1", ncol=3) + scale_color_gradientn(colors=c("blue","turquoise2","yellow","red","red4"), oob=scales::squish, limits=c(0,1))
```

```{r}
write.csv(query@meta.data, file = "./gene_sets/query_meta.csv", quote = FALSE)
```











